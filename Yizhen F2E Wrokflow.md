# Yizhen F2E Wrokflow

## 流程
这里的流程指的是项目的启动到线上发布，我们所要经历的：
- [x] 1. 切图 - 并不是所有资源都需要输出，依据实际情况而行。尽可能的使用无图 CSS。
- [x] 2. 创建模板 - 创建模版（html）、脚本（javascript）、样式（css、sass）文件，搭建基础的项目骨架。
- [x] 3. 文件编译 - 公共文件的引入后编译，sass 文件编译
- [ ] 4. 执行测试用例
- [ ] 5. 代码检测（sasslint, eslint）
- [ ] 6. 移除调试代码
- [ ] 7. 静态资源合并与优化
- [ ] 8. 静态资源通过hash计算指纹化（静态资源实现增量更新）
 
### 1. 切图
从上游设计稿中获取素材，一般常用的图标资源 UI 会帮忙导出，并输出一份带有标注的资源。以设计稿为准，做到像素级的页面还原；没有设计稿就以需求为准，涉及到的 UI 组件都继续沿用系统中的，或以系统中现有组件去扩展。在目前的自动化构建流程中有相关 `grunt-contrib-imagemin`

### 2. 创建模板
- html 部分需要创建项目中公共模块（类似 header, sidebar）的页面，以便于别的页面调用。
- js 部分需要引入公共组件等相关文件，项目中的各类组件已经非常多了，虽然目前没有什么影响，但当用户数量递增达到一定程度之后，还是应该加以优化减少服务器请求压力。 
- sass 以 bootstrap-sass 3.3.4 为基础，沿用这个文件结构，在这基础上根据项目再做部分适配和更改。

### 3. 文件编译
- html 部分创建的项目中公共区域调用方式采用 `grunt-include-replace`，编译输出到 `dist` 目录
- js 部分只是做了简单的合并和压缩。 `grunt-contrib-concat`, `grunt-contrib-uglify` 这两个
- sass `grunt-contrib-sass` 用来编译 sass，包括 bootstrap-sass 在内。

### 4. 执行测试用例
TODO

### 5. 代码检测
主要使用 `grunt-scss-lint` 用于审查代码，维护代码的一致性，减少冗余代码。检查代码是否符合编程规范以及查找代码错误。

TODO eslint

### 6. 移除调试代码
项目组中主要工作集中在交互和视觉上，scss 文件中的调试代码建议加上注释，并压缩打包输出。js 文件中的基本全靠人肉移除了，对于自动化流程上还需完善 TODO。

### 7. 静态资源合并与优化
- scss 文件最终会合并打包压缩输出成一个文件，但是这样有个问题，就是随着需求的不断增删、产品的迭代如果前期对各个模块没有细分的话，会无意中增加好多冗余代码。后期的重构打算就是把公共部分，公共组件单独分出来，不再和具体业务模块有关联，这部分就可以在各个项目中复用减小文件体积，但是无形中又增加了请求量 :-(，相关工具 `grunt-postcss`, `autoprefixer`, `grunt-contrib-cssmin`, `grunt-csscomb`, `grunt-scss-lint`
- sprite 借助 `grunt-spritesmith`，合成相应资源

### 8. 静态资源通过hash计算指纹化
静态资源更新缓存，看似简单切容易实现的需求，但是随着资源的增多在管理上就有些繁琐。

> 对付这个问题，目前来说最优方案就是基于文件内容的hash版本冗余机制了。也就是说，我们希望工程师源码是这么写的：
>
> `<script scr="a.js"></script>`
>
> 但是线上代码是这样的：
>
> `<script scr="a_82244e91.js"></script>`
>
> 其中 `_82244e91` 这串字符是根据 `a.js` 的文件内容进行hash运算得到的，只有文件内容发生变化了才会有更改。由于版本序列是与文件名写在一起的，而不是同名文件覆盖，因此不会出现上述说的那些问题。同时，这么做还有其他的好处：
> 
> 1. 线上的 a.js 不是同名文件覆盖，而是文件名+hash的冗余，所以可以先上线静态资源，再上线 html 页面，不存在间隙问题；
> 2. 遇到问题回滚版本的时候，无需回滚 a.js，只须回滚页面即可；
> 3. 由于静态资源版本号是文件内容的 hash，因此所有静态资源可以开启永久强缓存，只有更新了内容的文件才会缓存失效，缓存利用率大增；
> 4. 修改静态资源后会在线上产生新的文件，一个文件对应一个版本，因此不会受到构造 CDN 缓存形式的攻击

以上分析的这些来自这里 [前端工程精粹（一）：静态资源版本更新与缓存][2]，文章虽然比较久远了，久经考验目前看来也是符合工程标准的，需细细品读。

## 参考资料
- [停不下来的前端，自动化流程][1]
- [前端工程精粹（一）：静态资源版本更新与缓存][2]

[1]: http://www.alloyteam.com/2014/03/frontend-workflow/
[2]: http://www.infoq.com/cn/articles/front-end-engineering-and-performance-optimization-part1
